  scrape-batch:
    needs: calculate-batches
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix: ${{ fromJson(needs.calculate-batches.outputs.matrix) }}
      max-parallel: 1
      fail-fast: false
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Decrypt proxies file
      env:
        PROXY_PASSWORD: ${{ secrets.PROXY_PASSWORD }}
      run: |
        openssl enc -d -aes-256-cbc -pbkdf2 -in formatted_proxies.txt.enc -out formatted_proxies.txt -k "$PROXY_PASSWORD"

    - name: Run scraper for batch
      env:
        MAX_CONCURRENT: ${{ github.event.inputs.max_concurrent || '1' }}
      run: |
        python aa_hotels_scraper.py

    - name: Upload results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: results-batch-${{ matrix.batch.start }}
        path: |
          cheapest_10k_hotels_by_city.csv
